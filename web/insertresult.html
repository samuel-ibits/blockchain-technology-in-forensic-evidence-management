<!DOCTYPE html>

<html lang="en">
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4-rc.1/web3.min.js"></script>
    <script src="https://c0f4f41c-2f55-4863-921b-sdk-docs.github.io/cdn/metamask-sdk.js"></script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Insert Report</title>
    <link rel="stylesheet" href="insertresult.css" />
  </head>
  <body>
    <div class="top-section">
      <img src="images/logo.png" alt="" srcset="" />
    </div>
    <div class="pc-logo">
      <div class="pc-logo-img">
      <img src="./images/pc-logo.png" alt="" />
      </div>
    </div>
    <div class="flexed">
      <div class="wide-mobile">
        <form id="upload-form" enctype="multipart/form-data">
          <label for="image-upload"><div id="upload-container" class="container">
          </div></label>
            <input type="file" name="file" id="image-upload" accept="image/*" required />

          <button type="button" class="login-button" id="upload-button" onclick="connect()"  >Upload</button>
        </form>
      </div>
    </div>
<script>
/* To connect using MetaMask */
  async function connect() {

    
alert("clicked")
    if (window.ethereum) {



       try {

         await window.ethereum.request({ method: "eth_requestAccounts" });
         window.web3 = new Web3(window.ethereum);
         const web3account = web3.eth.accounts;
         //Get the current MetaMask selected/active wallet
         const walletAddress = web3account.givenProvider.selectedAddress;

         console.log('Wallet', walletAddress);
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' })
        const account = accounts[0]

        const publicKey = await window.ethereum.request({
          method: 'eth_getEncryptionPublicKey',
          params: [account],
        })
         console.log('Public Key:', publicKey);
         // Prepare the form data

         const formData = new FormData();
         const fileInput = document.querySelector('input[type="file"]');
         const file = fileInput.files[0];
         console.log(file.name)

         // append the file directly to a FormData
         formData.append('file', file, file.name);
         // formData.append("file", form.elements.file.files[0]);
         formData.append("ethAddress", walletAddress);

         if (!("TextEncoder" in window))
           alert("Sorry, this browser does not support TextEncoder...");

         var enc = new TextEncoder(); // always utf-8
         var unitarray=enc.encode(publicKey);
         formData.append("publicKey", publicKey);


         
         
        //  const msg = `0x${Buffer.from(exampleMessage, 'utf8').toString('hex')}`;
        //  const sign = await ethereum.request({
        //    method: 'personal_sign',
        //    params: ["Accept to process this request", walletAddress],
        //  });
         
         // Send the form data to your server
         const response = await fetch("http://localhost:3000/upload", {
           method: "POST",
           body: formData
         });
         console.log(response)
      } catch (error) {
        console.log("we3error",{ error })
      }
    }
      
 
 }
</script>
  </body>
</html>